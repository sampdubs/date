<!DOCTYPE html>
<html lang="en">

<head>
    <title>Waiting for players...</title>
</head>

<body>
    <div id="hand">
        <p>Your hand: {{ hand }}</p>
    </div>
    <p>Other players:</p>
    <div id="players">
        {% for player in players %}
        <p id="{{ player.sid }}" class="player">{{ player.name }}</p>
        {% endfor %}
    </div>
    <p>Game Log:</p>
    <div id="log" style="bottom: 0; position: fixed; overflow: scroll; height: 30%; width: 100%;">
        
    </div>
</body>

<script src={{ url_for('static', filename='jquery.min.js' ) }}></script>
<!-- Socket.IO for communication with the server -->
<script src={{ url_for('static', filename='socket.io.min.js' ) }}></script>

<script>
    const socket = io.connect('http://' + document.domain + ':' + location.port);

    const urlParts = window.location.href.split('/');
    const oldId = urlParts.pop() || urlParts.pop();
    let turn = '';

    // log function that adds a message to the log div
    function log(message) {
        $('#log').append($('<p>').text(message));
    }

    // emit id change
    socket.emit('change sid 2', { 'old': oldId });

    // when I get an sid change message
    socket.on('change sid', function (data) {
        // change the player's id
        $('#' + data.old).attr('id', data.sid);
    });

    // when I get the order message, remake the players div in that order
    socket.on('order', function (data) {
        // change the player's id
        $('#players').empty();
        $('#players').append('<p>Other players:</p>');
        const order = data.order;
        for (let i = 0; i < order.length; i++) {
            // if the player is not me
            if (order[i].sid != socket.id) {
                $('#players').append('<p id="' + order[i].sid + '" class="player">' + order[i].name + '</p>');
            }
        }
    });

    // when I get the turn message, change the turn
    socket.on('turn', function (data) {
        // remove the askterisk from the player who's turn it was if it wasn't me
        if (turn != socket.id && turn != '') {
            $('#' + turn).text($('#' + turn).text().replace(' *', ''));
        }

        turn = data.sid;

        // if it's not my turn, put an asterisk next to the player who's turn it is
        if (socket.id != turn) {
            $('#' + turn).append(' *');
        }

        // if it's my turn, add buttons next to other players' names that say "ask"
        if (socket.id == turn) {
            $('.player').each(function () {
                $(this).append(' <button id="askout' + $(this).attr('id') + '" class="askout">Ask on a date</button>');
            });
        }

        log(data.log);
    });

    // when an askout button is clicked, emit an askout message
    $(document).on('click', '.askout', function () {
        socket.emit('ask out', { 'sid': $(this).attr('id').replace('askout', '') });
        // delete all ask out buttons
        $('.askout').remove();
        // add a pending message next to the player I just asked out
        $('#' + $(this).attr('id').replace('askout', '')).append('<span id="pending">Date requested...</span>');
    });

    // when I get an ask out message, add a button next to the player who asked me out
    socket.on('ask out', function (data) {
        if (data.target == socket.id) {
            $('#' + data.origin).append(' <button id="accept' + data.origin + '" class="accept">Accept date request</button>');
        }

        log(data.log);
    });

    // when an accept button is clicked, emit an accept message
    $(document).on('click', '.accept', function () {
        console.log
        socket.emit('accept', { 'sid': $(this).attr('id').replace('accept', '') });
        // remove the button
        $(this).remove();
        // add a date accepted message next to the player who's date I just accepted
        $('#' + $(this).attr('id').replace('accept', '')).append('<span id="accepted">Date accepted!</span>');

    });

    // when I get an accept message
    socket.on('accept', function (data) {
        // remove the pending message
        $('#pending').remove();
        // add a date message next to the player who accepted my request
        $('#' + data.origin).append('<span id="accepted">Date accepted!</span>');

        log(data.log);
    });

</script>

</html>