<!DOCTYPE html>
<html lang="en">

<head>
    <title>Waiting for players...</title>
</head>

<body>
    <div id="handDiv">
        <p id="handContainer">Your hand: <span id="hand">{{ hand }}</span></p>
    </div>
    <p>Other players:</p>
    <div id="players">
        {% for player in players %}
        <p id="{{ player.sid }}" class="player">{{ player.name }}</p>
        {% endfor %}
    </div>
    <p>Game Log:</p>
    <div id="log" style="overflow: scroll; width: 100%;">
        
    </div>
</body>

<script src={{ url_for('static', filename='jquery.min.js' ) }}></script>
<!-- Socket.IO for communication with the server -->
<script src={{ url_for('static', filename='socket.io.min.js' ) }}></script>

<script>
    const socket = io.connect('http://' + document.domain + ':' + location.port);

    const urlParts = window.location.href.split('/');
    const oldId = urlParts.pop() || urlParts.pop();
    let turn = '';

    // log function that adds a message to the log div
    function log(message) {
        $('#log').append($('<p>').text(message));
        $('#log').scrollTop($('#log')[0].scrollHeight);
    }

    // emit id change
    socket.emit('change sid 2', { 'old': oldId });

    // when I get an sid change message
    socket.on('change sid', function (data) {
        // change the player's id
        $('#' + data.old).attr('id', data.sid);
    });

    // when I get the order message, remake the players div in that order
    socket.on('order', function (data) {
        // change the player's id
        $('#players').empty();
        const order = data.order;
        for (let i = 0; i < order.length; i++) {
            // if the player is not me
            if (order[i].sid != socket.id) {
                $('#players').append('<p id="' + order[i].sid + '" class="player">' + order[i].name + '</p>');
            }
        }
    });

    // when I get the turn message, change the turn
    socket.on('turn', function (data) {
        // remove the askterisk from the player who's turn it was if it wasn't me
        if (turn != socket.id && turn != '') {
            $('#' + turn).text($('#' + turn).text().replace(' *', ''));
        }

        turn = data.sid;

        // if it's not my turn, put an asterisk next to the player who's turn it is
        if (socket.id != turn) {
            $('#' + turn).append(' *');
        }

        // if it's my turn, add buttons next to other players' names that say "ask"
        if (socket.id == turn) {
            $('.player').each(function () {
                $(this).append(' <button id="askout' + $(this).attr('id') + '" class="askout">Ask on a date</button>');
            });
        }

        log(data.log);
    });

    // when an askout button is clicked, emit an askout message
    $(document).on('click', '.askout', function () {
        socket.emit('ask out', { 'sid': $(this).attr('id').replace('askout', '') });
        // delete all ask out buttons
        $('.askout').remove();
        // add a pending message next to the player I just asked out
        $('#' + $(this).attr('id').replace('askout', '')).append('<span id="pending">Date requested...</span>');
    });

    // when I get an ask out message, add a button next to the player who asked me out
    socket.on('ask out', function (data) {
        if (data.target == socket.id) {
            $('#' + data.origin).append(' <button id="accept' + data.origin + '" class="accept">Accept date request</button>');
        }

        log(data.log);
    });

    // when an accept button is clicked, emit an accept message
    $(document).on('click', '.accept', function () {
        console.log
        socket.emit('accept', { 'sid': $(this).attr('id').replace('accept', '') });
        // remove the button
        $(this).remove();
        // add a date accepted message next to the player who's date I just accepted
        $('#' + $(this).attr('id').replace('accept', '')).append('<span id="accepted">Date accepted!</span>');

    });

    // when I get an accept message
    socket.on('accept', function (data) {
        // remove the pending message
        $('#pending').remove();
        // add a date message next to the player who accepted my request
        if (data.target == socket.id) {
            $('#' + data.origin).append('<span id="accepted">Date accepted!</span>');
        }

        if (data.target == socket.id || data.origin == socket.id) {
            // add a trust card selection under the hand div
            $('#handDiv').append('<p class="trust">Select a trust card: </p>');
            // retrieve my hand as a list
            let hand = $('#hand').text().split(', ');
            // add a button for each trust card
            for (let i = 0; i < hand.length; i++) {
                $('#handDiv').append('<button id="trustcard' + hand[i] + '" class="trust">' + hand[i] + '</button>');
            }
            // when a trust card button is clicked, emit a trust exchange message
            $(document).on('click', '.trust', function () {
                const target = data.target == socket.id ? data.origin : data.target;
                socket.emit('trust exchange', { 'card': $(this).attr('id').replace('trustcard', ''), 'target': target });
                // add a message saying what trust card I sent next to target
                $('#accepted').text('Sent ' + $(this).attr('id').replace('trustcard', '') + ' as a trust card');
                // remove the first instance of the selected trust card from the hand
                delete hand[hand.indexOf($(this).attr('id').replace('trustcard', ''))];
                hand = hand.filter(e => e);
                $("#hand").text(hand.join(', '));
                // remove the trust card buttons
                $('.trust').remove();
            });
        }

        log(data.log);
    });

    // when I get a trust exchange message
    socket.on('trust exchange', function (data) {
        if (data['target'] == socket.id) {
            // Add a p right after handContainer saying what trust card I received
            $('#handContainer').after('<p id="trustHand">Trust card: ' + data['card'] + '</p>');
        }

        if (turn == socket.id && $("#trustHand").length > 0 && $(".trust").length == 0) {
            // Trust cards have been exchanged
            const so = data['target'] == socket.id ? data['origin'] : data['target'];
            // Add buttons next to so saying "ask on a second date" and "no second date"
            $('#' + so).append(' <button id="yessecond" class="second">Ask on a second date</button>');
            $('#' + so).append(' <button id="nosecond" class="second">No second date</button>');
            // When the yessecond button is clicked, emit a second date invite
            $(document).on('click', '#yessecond', function () {
                socket.emit('second date invite', { 'target': so });
                // remove the buttons
                $('.second').remove();
            });
            // When the nosecond button is clicked, emit a no second date message
            $(document).on('click', '#nosecond', function () {
                socket.emit('no second date', { 'target': so });
                // remove the buttons
                $('.second').remove();
                // Remove accepted
                $('#accepted').remove();
                // send back the trust card
                const trust = $('#trustHand').text().replace('Trust card: ', '');
                socket.emit('return trust', { 'card': trust, 'target': so });
                // Delete the trust hand
                $('#trustHand').remove();
            });
        }

        log(data.log);
    });

    // whe I get a no second date message
    socket.on('no second date', function (data) {
        if (data.target == socket.id) {
            // Remove accepted
            $('#accepted').remove();
            // send back the trust card
            const trust = $('#trustHand').text().replace('Trust card: ', '');
            socket.emit('return trust', { 'card': trust, 'target': data.origin });
            // Delete the trust hand
            $('#trustHand').remove();
        }

        log(data.log);
    });

    // when I get a return trust message
    socket.on('return trust', function (data) {
        if (data.target == socket.id) {
            // Add the trust card to my hand
            $('#hand').append(', ' + data.card);
        }

        log(data.log);
    })

    // when I get a second date invite message
    socket.on('second date invite', function (data) {
        // add a button next to the player who sent me a second date invite
        if (data.target == socket.id) {
            // Add a accept and reject button
            $('#' + data.origin).append(' <button id="acceptsecond' + data.origin + '" class="acceptsecond">Accept second date invite</button>');
            $('#' + data.origin).append(' <button id="rejectsecond' + data.origin + '" class="acceptsecond">Reject second date invite</button>');
            // when the acceptsecond button is clicked, emit an accept second date message
            $(document).on('click', '#acceptsecond' + data.origin, function () {
                // remove the buttons
                $(".acceptsecond").remove();
                // add a date accepted message next to the player who's second date I just accepted
                $('#' + data.origin).append('<span id="relationship"> In a relationship</span>');
                // Get the value of the trust card
                const trust = $('#trustHand').text().replace('Trust card: ', '');
                socket.emit('accept second date', { 'target': data.origin, 'card': trust });
                // Add the trust card to the hand
                $('#hand').append(', ' + trust);
                // Remove the trustHand and accepted
                $('#trustHand').remove();
                $('#accepted').remove();
            });
            // when the rejectsecond button is clicked, emit a reject second date message
            $(document).on('click', '#rejectsecond' + data.origin, function () {
                // remove the buttons
                $(".acceptsecond").remove();
                // Get the value of the trust card
                const trust = $('#trustHand').text().replace('Trust card: ', '');
                socket.emit('reject second date', { 'target': data.origin });
                // Return the trust card
                socket.emit('return trust', { 'card': trust, 'target': data.origin });
                // Remove the trustHand and accepted
                $('#trustHand').remove();
                $('#accepted').remove();
            });
        }

        log(data.log);
    });

    // when I get an accept second date message
    socket.on('accept second date', function (data) {
        if (data.target == socket.id) {
            // add a date accepted message next to the player who accepted my second date invite
            $('#' + data.origin).append('<span id="relationship"> In a relationship</span>');
                // Get the value of the trust card
                const trust = $('#trustHand').text().replace('Trust card: ', '');
                // Add the trust card to the hand
                $('#hand').append(', ' + trust);
                // Remove the trustHand and accepted
                $('#trustHand').remove();
                $('#accepted').remove();
        }

        log(data.log);
    });

    // when I get a reject second date message
    socket.on('reject second date', function (data) {
        if (data.target == socket.id) {
            // Remove accepted
            $('#accepted').remove();
            // Get the value of the trust card
            const trust = $('#trustHand').text().replace('Trust card: ', '');
            // Return the trust card
            socket.emit('return trust', { 'card': trust, 'target': data.origin });
            // Remove the trustHand and accepted
            $('#trustHand').remove();
            $('#accepted').remove();
        }

        log(data.log);
    });

</script>

</html>